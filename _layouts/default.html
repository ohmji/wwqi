<!DOCTYPE html>
<html lang="{{ site.lang | default: "en-US" }}">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    {% seo %}
    
    <link rel="stylesheet" href="{{ "/assets/css/retro-style.css" | relative_url }}">
    
    {% if site.google_analytics %}
      <script async src="https://www.googletagmanager.com/gtag/js?id={{ site.google_analytics }}"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '{{ site.google_analytics }}');
      </script>
    {% endif %}
  </head>
  
  <body>
    <div class="container">
      <header class="site-header">
        <nav class="site-nav">
          <ul>
            <li><a href="{{ "/" | relative_url }}">[HOME]</a></li>
            <li><a href="{{ "/analysis/" | relative_url }}">[PORTFOLIO]</a></li>
            <li><a href="{{ "/framework/" | relative_url }}">[FRAMEWORK]</a></li>
            <li><a href="https://github.com/{{ site.github_username }}/wwqi">[CODE]</a></li>
            <li><button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">[DARK]</button></li>
          </ul>
        </nav>
      </header>

      <main class="page-content" aria-label="Content">
        {{ content }}
      </main>

      <footer class="site-footer">
        <div class="footer-content">
          <div class="disclaimer-section">
            <h3>Investment Disclaimer</h3>
            <div class="warning-box">
              <p><strong>[!] EDUCATIONAL PURPOSE ONLY [!]</strong></p>
              <p>This analysis follows Charlie Munger's investment framework for educational purposes. Not financial advice. Consult qualified advisors before making investment decisions.</p>
            </div>
          </div>
          
          <div class="footer-divider"></div>
          
          <div class="footer-bottom">
            <div class="powered-by">
              <span class="retro-text">POWERED BY JEKYLL & GITHUB PAGES</span>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <!-- Retro JavaScript Effects -->
    <script>
      // Add random retro glitch effect
      function addGlitchEffect() {
        const elements = document.querySelectorAll('h1, h2, .stock-ticker');
        elements.forEach(el => {
          if (Math.random() < 0.1) {
            el.style.textShadow = '2px 0 #ff0000, -2px 0 #00ff00';
            setTimeout(() => {
              el.style.textShadow = '';
            }, 100);
          }
        });
      }

      // Add typing effect to certain elements
      function addTypingEffect(element, text, speed = 50) {
        element.innerHTML = '';
        let i = 0;
        const timer = setInterval(() => {
          if (i < text.length) {
            element.innerHTML += text.charAt(i);
            i++;
          } else {
            clearInterval(timer);
          }
        }, speed);
      }

      // Theme toggle functionality
      function initThemeToggle() {
        const toggle = document.getElementById('theme-toggle');
        const root = document.documentElement;
        
        // Get saved theme or default to dark
        const savedTheme = localStorage.getItem('theme') || 'dark';
        setTheme(savedTheme);
        
        function setTheme(theme) {
          if (theme === 'light') {
            root.classList.add('light-theme');
            toggle.textContent = '[LIGHT]';
            toggle.setAttribute('aria-label', 'Switch to dark theme');
          } else {
            root.classList.remove('light-theme');
            toggle.textContent = '[DARK]';
            toggle.setAttribute('aria-label', 'Switch to light theme');
          }
          localStorage.setItem('theme', theme);
        }
        
        function toggleTheme() {
          const currentTheme = root.classList.contains('light-theme') ? 'light' : 'dark';
          const newTheme = currentTheme === 'light' ? 'dark' : 'light';
          
          // Add transition effect
          root.style.transition = 'all 0.3s ease-in-out';
          setTheme(newTheme);
          
          // Remove transition after animation
          setTimeout(() => {
            root.style.transition = '';
          }, 300);
          
          // Add click feedback
          toggle.style.transform = 'scale(0.95)';
          setTimeout(() => {
            toggle.style.transform = '';
          }, 150);
        }
        
        toggle.addEventListener('click', toggleTheme);
        
        // Keyboard support
        toggle.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleTheme();
          }
        });
      }

      // Mobile reading enhancements
      function initMobileFeatures() {
        // Detect mobile device
        const isMobile = window.innerWidth <= 768 || 'ontouchstart' in window;
        
        if (isMobile) {
          // Add mobile class to body
          document.body.classList.add('mobile-device');
          
          // Improve touch feedback
          document.querySelectorAll('.stock-card, .analysis-card, .quick-link-card').forEach(card => {
            card.addEventListener('touchstart', function() {
              this.style.transform = 'scale(0.98)';
            });
            
            card.addEventListener('touchend', function() {
              setTimeout(() => {
                this.style.transform = '';
              }, 150);
            });
          });
          
          // Prevent 300ms click delay on mobile
          let lastTouchTime = 0;
          document.addEventListener('touchend', function(e) {
            const now = Date.now();
            if (now - lastTouchTime < 300) {
              e.preventDefault();
            }
            lastTouchTime = now;
          });
          
          // Optimize scrolling performance
          let ticking = false;
          function updateScrollPosition() {
            // Add scroll-based optimizations here if needed
            ticking = false;
          }
          
          document.addEventListener('scroll', function() {
            if (!ticking) {
              requestAnimationFrame(updateScrollPosition);
              ticking = true;
            }
          }, { passive: true });
          
          // Adjust viewport on orientation change
          window.addEventListener('orientationchange', function() {
            setTimeout(() => {
              window.scrollTo(0, 0);
            }, 100);
          });
        }
        
        // Reading mode toggle for better mobile reading
        const readingModeKey = 'reading-mode';
        let isReadingMode = localStorage.getItem(readingModeKey) === 'true';
        
        function toggleReadingMode() {
          isReadingMode = !isReadingMode;
          localStorage.setItem(readingModeKey, isReadingMode);
          
          const mainContent = document.querySelector('.page-content');
          if (mainContent) {
            if (isReadingMode) {
              mainContent.classList.add('reading-mode');
            } else {
              mainContent.classList.remove('reading-mode');
            }
          }
        }
        
        // Initialize reading mode
        if (isReadingMode) {
          const mainContent = document.querySelector('.page-content');
          if (mainContent) {
            mainContent.classList.add('reading-mode');
          }
        }
        
        // Add reading mode toggle on double-tap (mobile only)
        if (isMobile) {
          let lastTapTime = 0;
          document.addEventListener('touchend', function(e) {
            const currentTime = Date.now();
            const tapLength = currentTime - lastTapTime;
            if (tapLength < 500 && tapLength > 0) {
              // Double tap detected
              if (e.target.closest('p, h1, h2, h3, li')) {
                toggleReadingMode();
              }
            }
            lastTapTime = currentTime;
          });
        }
      }

      // Add retro loading effects
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize mobile features
        initMobileFeatures();
        
        // Initialize theme toggle
        initThemeToggle();
        
        // Random glitch effect every 10 seconds
        setInterval(addGlitchEffect, 10000);
        
        // Enhanced hover effects for navigation and buttons
        document.querySelectorAll('.retro-button').forEach(button => {
          button.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05) rotate(1deg)';
          });
          
          button.addEventListener('mouseleave', function() {
            this.style.transform = '';
          });
        });

        // Advanced navigation hover effects with staggered animations
        document.querySelectorAll('.site-nav a').forEach((link, index) => {
          link.addEventListener('mouseenter', function() {
            // Add subtle ripple effect
            const ripple = document.createElement('span');
            ripple.className = 'nav-ripple';
            this.appendChild(ripple);
            
            // Remove ripple after animation
            setTimeout(() => {
              if (ripple.parentNode) {
                ripple.parentNode.removeChild(ripple);
              }
            }, 600);
          });
          
          // Add staggered glow effect for navigation items
          link.addEventListener('mouseenter', function() {
            this.style.setProperty('--hover-delay', `${index * 50}ms`);
          });
        });

        // Dropdown menu enhanced interactions
        document.querySelectorAll('.site-nav .dropdown').forEach(dropdown => {
          const menu = dropdown.querySelector('.dropdown-menu');
          if (menu) {
            let hoverTimer;
            
            dropdown.addEventListener('mouseenter', function() {
              clearTimeout(hoverTimer);
              menu.style.animation = 'slideIn 0.3s ease-out';
            });
            
            dropdown.addEventListener('mouseleave', function() {
              hoverTimer = setTimeout(() => {
                menu.style.animation = 'slideOut 0.3s ease-in';
              }, 100);
            });
          }
        });

        // Add click effects
        document.querySelectorAll('.stock-card').forEach(card => {
          card.addEventListener('click', function() {
            this.style.animation = 'none';
            setTimeout(() => {
              this.style.animation = 'pulse 0.5s ease-in-out';
            }, 10);
          });
        });
      });

      // Add CSS animations for enhanced hover effects
      const style = document.createElement('style');
      style.textContent = `
        @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.02); }
          100% { transform: scale(1); }
        }
        
        @keyframes slideIn {
          0% { 
            opacity: 0; 
            transform: translateY(-10px) scale(0.95); 
          }
          100% { 
            opacity: 1; 
            transform: translateY(0) scale(1); 
          }
        }
        
        @keyframes slideOut {
          0% { 
            opacity: 1; 
            transform: translateY(0) scale(1); 
          }
          100% { 
            opacity: 0; 
            transform: translateY(-10px) scale(0.95); 
          }
        }
        
        @keyframes ripple {
          0% { 
            transform: scale(0); 
            opacity: 0.6; 
          }
          50% { 
            opacity: 0.3; 
          }
          100% { 
            transform: scale(2); 
            opacity: 0; 
          }
        }
        
        .nav-ripple {
          position: absolute;
          top: 50%;
          left: 50%;
          width: 20px;
          height: 20px;
          background: radial-gradient(circle, var(--green-keyword) 0%, transparent 70%);
          border-radius: 50%;
          transform: translate(-50%, -50%) scale(0);
          animation: ripple 0.6s ease-out;
          pointer-events: none;
          z-index: 0;
        }
        
        .site-nav a * {
          position: relative;
          z-index: 1;
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>